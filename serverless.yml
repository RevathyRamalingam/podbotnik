# Serverless Framework configuration for AWS Lambda deployment
# Install Serverless: npm install -g serverless
# Deploy: serverless deploy
# Invoke: serverless invoke -f ask -d '{"body": "{\"question\":\"...\"}"}'

service: podbotnik

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  memorySize: 512
  timeout: 30
  
  environment:
    GROQ_API_KEY: ${env:GROQ_API_KEY}
    TRANSCRIPTS_BUCKET: ${env:TRANSCRIPTS_BUCKET, ''}
    TRANSCRIPTS_KEY: ${env:TRANSCRIPTS_KEY, 'transcripts.json'}
  
  iamRoleStatements:
    # Allow reading transcripts from S3
    - Effect: Allow
      Action:
        - s3:GetObject
      Resource: !Sub 'arn:aws:s3:::${TranscriptsBucket}/*'
    
    # CloudWatch Logs
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*'

functions:
  ask:
    handler: lambda_handler.handler
    events:
      - http:
          path: /api/ask
          method: post
          cors: true
    description: Answer questions about podcasts
  
  episodes:
    handler: lambda_handler.handler
    events:
      - http:
          path: /api/episodes
          method: get
          cors: true
    description: List all episodes
  
  search:
    handler: lambda_handler.handler
    events:
      - http:
          path: /api/search
          method: post
          cors: true
    description: Search transcript segments
  
  root:
    handler: lambda_handler.handler
    events:
      - http:
          path: /
          method: get
          cors: true
    description: API root endpoint

# Package configuration
package:
  patterns:
    - '!venv/**'
    - '!node_modules/**'
    - '!.git/**'
    - '!*.md'
    - '!.env*'
    - '!docker*'
    - '!setup.py'
    - '!test.py'
    - '!web.py'
    - '!cli.py'
    - '!example.py'
    - '!api.py'
    - '!transcript_generator.py'
    - '.gitignore'

# Custom resources
resources:
  Resources:
    TranscriptsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${env:TRANSCRIPTS_BUCKET_NAME, 'podbotnik-transcripts-${aws:accountId}'}
        VersioningConfiguration:
          Status: Enabled

# Outputs
outputs:
  AskEndpoint:
    Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/dev/api/ask'
    Description: Ask a question endpoint
  
  EpisodesEndpoint:
    Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/dev/api/episodes'
    Description: List episodes endpoint
  
  SearchEndpoint:
    Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/dev/api/search'
    Description: Search endpoint
  
  TranscriptsBucket:
    Value: !Ref TranscriptsBucket
    Description: S3 bucket for storing transcripts
